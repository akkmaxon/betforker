#!/usr/bin/env ruby
$LOAD_PATH << File.expand_path(File.dirname(__FILE__) + '/../lib')
require 'forker'
open(File.dirname(__FILE__) + '/../config.yml') {|f| $config = YAML.load(f)}
####################let's go
output = Output.new
time_of_beginning = Time.now.to_i
while (Time.now.to_i - time_of_beginning) < $config[:time_of_work]
  beginning_loop = Time.now.to_i
  tries = 0
  begin
    tries += 1
    events = Eventsfinder.new({
                                bookies: $config[:bookies],
                                downloader: Downloader.new
                              }).well_structured_events
  rescue
    puts "Error in bin/forker!!!"
    retry if tries < 3
  end
  events ||= Hash.new
  output.before_work(events)
  parsed_events = []
  events.each do |key,arr|
    tries = 0
    begin
      tries += 1
      downloader = Downloader.new
      arr.each do |addr|
        html = downloader.download(addr)
        bookmaker = Forksfinder::init_bookmaker(addr)
        preparsed_event = bookmaker.event_parsed(html)
	if preparsed_event[:home_player][:name] < preparsed_event[:away_player][:name]
	  parsed_event = Forksfinder::change_names(preparsed_event)
	end
        parsed_events << parsed_event
      end
    rescue
      retry if tries < 3
    end
    output.parsed_bookies(parsed_events)
    forks = forker.forking(parsed_events, Comparer.new)
    output.to_screen(forks) unless forks.empty?
  end
  output.after_work(beginning_loop)
  break if $config[:falling_phantomjs]
end
