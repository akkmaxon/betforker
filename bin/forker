#!/usr/bin/env ruby
$LOAD_PATH << File.expand_path(File.dirname(__FILE__) + '/../lib')
require 'forker'
include Forker

class Forker::App < Thor

  if ARGV.size == 0
    ARGV << 'default'
  end

  desc 'config', 'Change app\'s configuration'
  map '-c' => :config, '--config' => :config
  def config
    if Config.update
      open(File.dirname(__FILE__) + '/../config.yml', 'w') do |file|
	yaml = YAML.dump $config
	file.write yaml
      end
    end
  end

  desc 'events', 'List all current live events and exit'
  map '-e' => :events, '--events' => :events
  def events
    Forker.build_events $config[:bookmakers], $config[:sport]
  end

  desc 'parse ADDRESS', 'Parse event of given address'
  map '-p' => :parse, '--parse' => :parse
  def parse(address)
    Downloader.prepare_phantomjs
    event = Event.new [address]
    event.get_webpages
    event.parse_webpages $config[:bookmakers]
    event.print_parsed_webpages
  end

  desc 'version', 'Show version of forker'
  map '-v' => :version, '--version' => :version
  def version
    say "Version: #{Forker::VERSION}"
  end

  desc 'silent', 'Run forker without logs with showing only desktop notifications'
  map '-s' => :silent, '--silent' => :silent
  def silent
    $config[:log] = false
    default
  end

  desc 'default', 'Run forker with logs and notifications if forks were found(default mode)'
  def default
    loop do
      events = Forker::build_events $config[:bookmakers], $config[:sport]
      events_size = events.size
      events.each_with_index do |event, index|
	event.print_message_about_event(events_size, index + 1) if $config[:log]
	forks = event.find_forks
	forks.each do |f|
	  f.desktop_show
	end
      end
      Capybara.current_session.driver.browser.restart
    end
  end
end

Forker::App.start
